# Auth

## Migration Plan: Auth.js to Supabase Auth

> 03-31-2025, gemini-2.5-pro-exp-03-25

Okay, I understand you want to migrate from Auth.js (with GitHub provider) to Supabase Auth for a more streamlined setup within your Next.js application. That makes sense, especially since you're already using Supabase for your database.

Before we make any changes, let's review the current setup and outline a plan.

**1. Current Auth.js Implementation:**

*   **Configuration (`auth.ts`):** You have a basic NextAuth setup using the `GitHub` provider.
*   **Middleware (`middleware.ts`):** You're using the `auth` middleware helper from `next-auth` to protect specific routes (`/sound`, `/dashboard`, `/lab`). Accessing these routes without authentication redirects the user to `/login`.
*   **Dependencies (`package.json`):** You have `next-auth` and `@auth/core` installed.
*   **API Route:** There's an `app/api/auth/[...nextauth]/` directory, which likely contains the standard NextAuth API handlers generated by `NextAuth({ providers: [GitHub] })`.

**2. Current Supabase Integration:**

*   **Server Client (`db/supabase/server.ts`):** You're using `@supabase/ssr`'s `createServerClient` correctly for server-side operations. Importantly, you have `auth: { persistSession: false }` set. This was likely done because Auth.js was handling sessions, but we'll need to change this to let Supabase manage auth state.
*   **Database Schema (`docs/DATABASE.md`, `lib/types/database.ts`):** You have a `public.users` table with `id`, `email`, and `role` (admin, vip, guest). This is separate from Supabase Auth's built-in `auth.users` table.
*   **Services (`db/services/*`):** These interact with the database but don't seem directly tied to the *Auth.js* user object currently.
*   **Dependencies (`package.json`):** You have `@supabase/ssr` and `@supabase/supabase-js`.

**3. Proposed Migration Plan to Supabase Auth:**

Hereâ€™s a step-by-step plan to migrate to Supabase Auth:

*   **Uninstall Auth.js:**
    *   Remove the `next-auth` and `@auth/core` packages from `package.json`.
    *   Delete the `auth.ts` file.
    *   Delete the `app/api/auth/[...nextauth]` directory and its contents.
*   **Configure Supabase for Auth:**
    *   **Environment Variables:** Ensure `NEXT_PUBLIC_SUPABASE_URL` and `NEXT_PUBLIC_SUPABASE_ANON_KEY` are correctly set in your environment variables (`.env.local` or similar). You will also need to add your GitHub OAuth app's Client ID and Secret to your Supabase project's authentication settings via the Supabase dashboard, *not* directly in your codebase env variables. Supabase handles the provider configuration server-side.
    *   **Supabase Client (`db/supabase/server.ts`):** Remove or comment out `auth: { persistSession: false }`. The `@supabase/ssr` package is designed to handle session persistence via cookies when this isn't explicitly disabled. We might need dedicated client and server component helpers provided by `@supabase/ssr` for different contexts.
    *   **Create Supabase Client Helper (`db/supabase/client.ts`):** Create a similar helper function using `createBrowserClient` from `@supabase/ssr` for use in client components.
    *   **Create Supabase Middleware Helper (`db/supabase/middleware.ts`):** Create a helper using `createServerClient` specifically configured for middleware usage, as recommended by `@supabase/ssr` documentation.
*   **Implement Auth Flow:**
    *   **Callback Route:** Supabase handles OAuth callbacks differently. We'll need to create an API route (e.g., `app/auth/callback/route.ts`) that uses `@supabase/ssr` to exchange the code for a session and redirect the user.
    *   **Sign-in/Sign-out:** Update your UI components (e.g., Login page, user menu) to use Supabase client methods:
        *   `supabase.auth.signInWithOAuth({ provider: 'github', options: { redirectTo: '...' } })` for initiating the GitHub login flow.
        *   `supabase.auth.signOut()` for logging out.
*   **Update Middleware (`middleware.ts`):**
    *   Replace the `next-auth` middleware logic.
    *   Import the Supabase middleware client helper (`db/supabase/middleware.ts`).
    *   In the middleware function, fetch the current session using the Supabase client (`await supabase.auth.getSession()`).
    *   Check if `session` exists. If not, and the route is protected, redirect to the login page.
    *   The `@supabase/ssr` package requires middleware to refresh session cookies, so the middleware will need to include response handling as shown in their docs.
*   **Handle User Data (`public.users` vs. `auth.users`):**
    *   Supabase Auth uses its own `auth.users` table. The `public.users` table you have is separate. We need to decide how to link these or consolidate.
    *   **Recommendation:** Create a new `public.profiles` table linked to `auth.users` via a foreign key (`id UUID REFERENCES auth.users(id)`). This table can store application-specific data like the `role` enum (`admin`, `vip`, `guest`).
    *   **Database Trigger:** Set up a PostgreSQL trigger in your Supabase database that automatically creates a new row in `public.profiles` whenever a new user signs up (i.e., a new row is inserted into `auth.users`), copying the user ID and potentially defaulting the role.
    *   **Migration:** Migrate any existing user data from `public.users` to the new `public.profiles` structure if necessary, and then drop the old `public.users` table. Update database services and queries (`db/services/*`, `db/queries/*`) to use the `profiles` table.
*   **Update Code:**
    *   Search the codebase for any remaining uses of `useSession`, `getSession`, `signIn`, `signOut` from `next-auth` and replace them with Supabase equivalents (e.g., getting user info via `supabase.auth.getUser()`).

**Next Steps:**

Does this plan make sense? Specifically, what are your thoughts on handling the user data by creating a `public.profiles` table linked to `auth.users` and using a trigger, then migrating/removing the existing `public.users` table? This is a common pattern with Supabase Auth.

Once we agree on the plan, I can start assisting with the implementation steps.
